# Advanced Features

This guide covers advanced configuration options and use cases for Stream Harvestarr.

## Table of Contents

- [Cookie Authentication](#cookie-authentication)
- [Custom Video Formats](#custom-video-formats)
- [Subtitle Configuration](#subtitle-configuration)
- [Time Offsets](#time-offsets)
- [Regex Title Matching](#regex-title-matching)
- [Playlist Handling](#playlist-handling)
- [Multiple Series Management](#multiple-series-management)

## Cookie Authentication

Cookies allow Stream Harvestarr to access member-only, age-restricted, or login-required content.

### Extracting Cookies

**Method 1: Browser Extension**

1. Install a cookie export extension:
   - Chrome: "Get cookies.txt"
   - Firefox: "cookies.txt"
2. Navigate to the site (e.g., youtube.com) while logged in
3. Export cookies to Netscape format
4. Save as `youtube_cookies.txt`

**Method 2: YT-DLP**

```bash
yt-dlp --cookies-from-browser firefox --cookies youtube_cookies.txt "https://www.youtube.com/"
```

Supported browsers: chrome, firefox, safari, edge, opera, brave

### Using Cookies

1. Place cookie file in config directory:
```bash
/path/to/config/
├── config.yml
└── youtube_cookies.txt
```

2. Reference in config:
```yaml
series:
  - title: Members Only Series
    url: https://www.youtube.com/channel/UC_CHANNEL_ID
    cookies_file: youtube_cookies.txt
```

### Cookie Security

- Cookie files contain authentication tokens
- Keep them private and secure
- Don't commit to version control
- Regenerate if exposed
- Cookie files should have restricted permissions:

```bash
chmod 600 /path/to/config/youtube_cookies.txt
```

### Troubleshooting Cookies

**Cookies not working:**

1. Check file format (must be Netscape format)
2. Verify file path is relative to config directory
3. Ensure cookies haven't expired
4. Confirm you're logged in when extracting
5. Check file permissions

**Example cookie file format:**
```
# Netscape HTTP Cookie File
.youtube.com	TRUE	/	TRUE	1234567890	COOKIE_NAME	cookie_value
```

## Custom Video Formats

YT-DLP provides powerful format selection capabilities.

### Format Selection Syntax

Basic format string structure:
```
[quality_filter][+][audio_filter]/[fallback]
```

### Common Format Examples

**Best quality available:**
```yaml
format: bestvideo+bestaudio/best
```

**1080p maximum:**
```yaml
format: bestvideo[height<=1080]+bestaudio/best[height<=1080]
```

**720p maximum:**
```yaml
format: bestvideo[height<=720]+bestaudio/best[height<=720]
```

**4K maximum:**
```yaml
format: bestvideo[height<=2160]+bestaudio/best[height<=2160]
```

**Specific container formats:**
```yaml
format: bestvideo[ext=mp4]+bestaudio[ext=m4a]/best[ext=mp4]/best
```

**Prefer webm, fallback to mp4:**
```yaml
format: bestvideo[ext=webm]+bestaudio[ext=webm]/bestvideo[ext=mp4]+bestaudio[ext=m4a]/best
```

**Limit file size (approximate):**
```yaml
format: bestvideo[filesize<500M]+bestaudio/best[filesize<500M]
```

**Prefer 60fps:**
```yaml
format: bestvideo[fps>=60]+bestaudio/bestvideo+bestaudio/best
```

### Per-Series Format Override

Override default format for specific series:

```yaml
ytdl:
    default_format: bestvideo[height<=1080]+bestaudio/best

series:
  # Use default format
  - title: Regular Series
    url: https://youtube.com/...

  # Override with 4K
  - title: High Quality Series
    url: https://youtube.com/...
    format: bestvideo[height<=2160]+bestaudio/best

  # Override with 720p for size
  - title: Large Series Archive
    url: https://youtube.com/...
    format: bestvideo[height<=720]+bestaudio/best
```

### Testing Format Selection

Test format selection before adding to config:

```bash
docker exec stream-harvestarr yt-dlp -F "VIDEO_URL"
```

This lists all available formats. Then test your format string:

```bash
docker exec stream-harvestarr yt-dlp -f "bestvideo[height<=1080]+bestaudio" --skip-download "VIDEO_URL"
```

## Subtitle Configuration

Download and embed subtitles in your videos.

### Basic Subtitle Setup

```yaml
series:
  - title: Series Name
    url: https://youtube.com/...
    subtitles:
      languages: ['en']
      autogenerated: False
```

### Multiple Languages

```yaml
series:
  - title: International Series
    url: https://youtube.com/...
    subtitles:
      languages: ['en', 'es', 'fr', 'de']
      autogenerated: False
```

### Including Auto-Generated Subtitles

```yaml
series:
  - title: Series Name
    url: https://youtube.com/...
    subtitles:
      languages: ['en']
      autogenerated: True  # Include YouTube auto-captions
```

### Subtitle Language Codes

Common language codes:
- `en` - English
- `es` - Spanish
- `fr` - French
- `de` - German
- `it` - Italian
- `pt` - Portuguese
- `ja` - Japanese
- `ko` - Korean
- `zh` - Chinese
- `ru` - Russian
- `ar` - Arabic

Full list: [ISO 639-1 codes](https://en.wikipedia.org/wiki/List_of_ISO_639-1_codes)

### Subtitle Format

Subtitles are:
1. Downloaded as `.vtt` files
2. Converted to `.srt` format
3. Embedded in the video file
4. Also kept as separate `.srt` files

### Finding Available Subtitles

Check what subtitles are available:

```bash
docker exec stream-harvestarr yt-dlp --list-subs "VIDEO_URL"
```

## Time Offsets

Handle early-access or time-delayed content with offset configuration.

### Use Cases

- **Member early access:** Videos available to members days before public release
- **Patreon exclusives:** Content released early to supporters
- **Time zone handling:** Accounting for release time differences
- **Embargo periods:** Content with staggered release schedules

### Offset Configuration

```yaml
series:
  - title: Series Name
    url: https://youtube.com/...
    offset:
      weeks: 0
      days: 2
      hours: 12
      minutes: 30
```

All fields are optional. Offsets are additive.

### Example Scenarios

**Member videos release 3 days early:**
```yaml
offset:
  days: 3
```

**Videos release 1 week early for top-tier patrons:**
```yaml
offset:
  weeks: 1
```

**Content embargoed for 48 hours:**
```yaml
offset:
  days: 2
```

**Videos available 6 hours early:**
```yaml
offset:
  hours: 6
```

**Complex: 1 week + 2 days + 6 hours:**
```yaml
offset:
  weeks: 1
  days: 2
  hours: 6
```

### How Offsets Work

Without offset:
```
Episode airs: 2025-01-01 00:00:00
Sonarr sees it: Immediately
Download attempt: 2025-01-01 00:00:00
```

With 3-day offset:
```
Episode airs: 2025-01-01 00:00:00
Sonarr sees it: Immediately
Download attempt: 2025-01-04 00:00:00 (3 days later)
```

This prevents attempting to download content that isn't available yet.

## Regex Title Matching

Use regular expressions to transform episode titles for matching.

### Why Use Regex?

- YouTube and TVDB use different naming conventions
- Episode numbers formatted differently
- Special characters or extra text in titles
- Series/season identifiers mismatch

### Basic Regex Configuration

```yaml
series:
  - title: Series Name
    url: https://youtube.com/...
    regex:
      sonarr:
        match: 'pattern'
        replace: 'replacement'
      site:
        match: 'pattern'
        replace: 'replacement'
```

### Common Regex Examples

**Remove trailing episode numbers:**

YouTube: "Episode Title - #12"
TVDB: "Episode Title"

```yaml
regex:
  sonarr:
    match: '.-.#[0-9]+$'
    replace: ''
```

**Convert episode format:**

YouTube: "Ep01 - Title"
TVDB: "Episode 1 - Title"

```yaml
regex:
  site:
    match: '^Ep([0-9]+)'
    replace: 'Episode \\1'
```

**Remove season prefix:**

YouTube: "S02E05 - Title"
TVDB: "E05 - Title"

```yaml
regex:
  site:
    match: '^S[0-9]+E'
    replace: 'E'
```

**Standardize spacing:**

YouTube: "Episode Title:Part 2"
TVDB: "Episode Title: Part 2"

```yaml
regex:
  site:
    match: ':([A-Z])'
    replace: ': \\1'
```

**Remove extra descriptors:**

YouTube: "Episode 5 - Title (Extended Cut)"
TVDB: "Episode 5 - Title"

```yaml
regex:
  site:
    match: '\\s*\\([^)]+\\)$'
    replace: ''
```

### Regex Testing

Test your regex patterns:

1. **Online:** Use [regex101.com](https://regex101.com/) (select Python flavor)
2. **In logs:** Enable debug mode to see title matching attempts

```yaml
streamharvestarr:
    debug: True
```

### Advanced: Multiple Replacements

Apply both Sonarr and site transformations:

```yaml
series:
  - title: Complex Series
    url: https://youtube.com/...
    regex:
      sonarr:
        match: ' - Season [0-9]+'
        replace: ''
      site:
        match: '^\\[[A-Z]+\\]\\s*'
        replace: ''
```

## Playlist Handling

Configure how playlists are processed.

### Playlist Order

**Default behavior (reverse):**
```yaml
series:
  - title: Series Name
    url: https://youtube.com/playlist?list=...
    playlistreverse: True  # Oldest first (default)
```

**Newest first:**
```yaml
series:
  - title: Series Name
    url: https://youtube.com/playlist?list=...
    playlistreverse: False  # Newest first
```

### When to Use Each

**Reverse (True) - Default:**
- Most web series (episodes released chronologically)
- Archive playlists (oldest episode is #1)
- Sequential content

**Not Reversed (False):**
- Playlists where newest videos are most important
- "Latest uploads" playlists
- Reverse-chronological content

### Playlist vs Channel

**Playlist URL:**
```yaml
url: https://www.youtube.com/playlist?list=PLxxxxxxxx
```
- Only includes videos in that specific playlist
- Controlled playlist order
- May not include all uploads

**Channel URL:**
```yaml
url: https://www.youtube.com/channel/UCxxxxxxxx
```
- Includes all uploads to channel
- Chronological order
- May include videos not in specific playlists

### Finding Playlist IDs

1. Navigate to playlist on YouTube
2. URL shows: `youtube.com/playlist?list=PLxxxxxxxx`
3. Copy entire URL including `list=` parameter

## Multiple Series Management

Best practices for managing many series.

### Organization Strategies

**Group by source:**
```yaml
series:
  # YouTube Series
  - title: YouTube Series 1
    url: https://youtube.com/...

  - title: YouTube Series 2
    url: https://youtube.com/...

  # Vimeo Series
  - title: Vimeo Series 1
    url: https://vimeo.com/...
```

**Group by configuration type:**
```yaml
series:
  # Standard series (no special config)
  - title: Simple Series 1
    url: https://youtube.com/...

  # Member-only series (cookies required)
  - title: Members Series 1
    url: https://youtube.com/...
    cookies_file: youtube_cookies.txt

  # High quality series (custom format)
  - title: HQ Series 1
    url: https://youtube.com/...
    format: bestvideo[height<=2160]+bestaudio/best
```

### Shared Configuration

Some settings apply to all matching series:

**Cookies can be shared:**
```yaml
series:
  - title: Channel A - Members
    url: https://youtube.com/channel/...
    cookies_file: youtube_cookies.txt

  - title: Channel A - Public
    url: https://youtube.com/channel/...
    cookies_file: youtube_cookies.txt  # Same cookies
```

**Format can be defined per-series:**
```yaml
series:
  - title: 4K Content
    url: https://youtube.com/...
    format: bestvideo[height<=2160]+bestaudio/best

  - title: Archive Content
    url: https://youtube.com/...
    format: bestvideo[height<=720]+bestaudio/best
```

### Performance Considerations

With many series:

1. **Increase scan interval:**
```yaml
streamharvestarr:
    scan_interval: 5  # Check every 5 minutes instead of 1
```

2. **Enable rate limiting:**
```yaml
streamharvestarr:
    download_delay: 10
    sleep_requests: 2
```

3. **Stagger series monitoring** in Sonarr (monitor only actively releasing series)

### Maintenance

**Regular tasks:**

1. **Review monitored series** - Unmonitor completed series in Sonarr
2. **Update cookie files** - Refresh when they expire (usually 6-12 months)
3. **Check logs** - Look for recurring failures
4. **Update TVDB** - Ensure episode titles match

**Example maintenance script:**
```bash
#!/bin/bash
# Check which series have recent errors
grep "Failed -" /path/to/logs/stream-harvestarr.log | \
    awk -F' - ' '{print $3}' | \
    sort | uniq -c | sort -rn
```

## Related Pages

- [Configuration Guide](Configuration) - Full config reference
- [Rate Limiting](Rate-Limiting) - Handling rate limits
- [Troubleshooting](Troubleshooting) - Common issues and solutions
